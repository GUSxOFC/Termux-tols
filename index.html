<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>gusofc_terminal_v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0d0d0d; color: #e0e0e0; font-family: 'Roboto Mono', monospace; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .header-frame { background-color: #1a1a1a; padding: 10px 20px; border-bottom: 3px solid #ffb000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 20px #ffb000; }
        .terminal-id { font-family: 'Fira Code', monospace; font-size: 1.4em; color: #ffb000; text-shadow: 0 0 8px #ffb000; letter-spacing: 1px; }
        .control-panel { display: flex; gap: 10px; }
        .control-button { background-color: #333; color: #e0e0e0; border: 1px solid #555; padding: 6px 12px; font-family: 'Fira Code', monospace; cursor: pointer; border-radius: 3px; transition: all 0.2s ease; }
        .control-button:hover { background-color: #ffb000; color: #0d0d0d; border-color: #ffb000; transform: translateY(-2px); }
        .terminal-screen { flex-grow: 1; padding: 15px; overflow-y: auto; background-image: repeating-linear-gradient(#0d0d0d, #0d0d0d 9px, #111111 9px, #111111 10px); }
        .terminal-screen::-webkit-scrollbar { width: 8px; }
        .terminal-screen::-webkit-scrollbar-track { background: #1a1a1a; }
        .terminal-screen::-webkit-scrollbar-thumb { background: #ffb000; border: 1px solid #0d0d0d; }
        .log-entry { display: flex; margin-bottom: 18px; animation: entry-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes entry-pop { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .user-icon, .ai-icon { width: 40px; height: 40px; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; margin-right: 15px; flex-shrink: 0; border: 2px solid; }
        .user-icon { background-color: #1a2f1a; border-color: #00ff00; color: #00ff00; }
        .ai-icon { background-color: #2f1a1a; border-color: #ff4500; color: #ff4500; }
        .message-bubble { background-color: #1a1a1a; padding: 12px 16px; border-radius: 5px; border: 1px solid #333; flex-grow: 1; position: relative; }
        .message-bubble p { margin: 0; white-space: pre-wrap; word-break: break-word; line-height: 1.5; }
        .code-snippet { margin-top: 12px; border-left: 4px solid #ffb000; background-color: #222; padding: 15px; border-radius: 0 5px 5px 0; box-shadow: 3px 3px 10px rgba(0,0,0,0.5); position: relative; }
        .code-snippet::before { content: '>'; position: absolute; top: 5px; left: -20px; color: #ffb000; font-size: 20px; font-family: 'Fira Code', monospace; }
        .code-snippet pre { margin: 0; font-family: 'Fira Code', monospace; color: #e0e0e0; white-space: pre-wrap; word-wrap: break-word; }
        .code-actions { margin-top: 10px; display: flex; gap: 8px; }
        .code-action-btn { background: none; border: 1px solid #555; color: #e0e0e0; padding: 4px 8px; font-size: 12px; cursor: pointer; border-radius: 3px; font-family: 'Roboto Mono', monospace; }
        .code-action-btn:hover { background-color: #ffb000; color: #0d0d0d; border-color: #ffb000; }
        .typing-indicator { display: none; align-items: center; }
        .typing-indicator span { display: inline-block; width: 8px; height: 8px; background-color: #ff4500; border-radius: 50%; margin-right: 5px; animation: typing-bounce 1.2s infinite ease-in-out; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: -0.4s; }
        @keyframes typing-bounce { 0%, 60%, 100% { transform: scale(0.8); opacity: 0.5; } 30% { transform: scale(1); opacity: 1; } }
        .input-section { background-color: #1a1a1a; padding: 15px; border-top: 3px solid #ffb000; display: flex; gap: 12px; }
        #command-input { flex-grow: 1; background-color: #0d0d0d; border: 2px solid #333; color: #e0e0e0; padding: 10px 15px; font-family: 'Roboto Mono', monospace; font-size: 16px; outline: none; border-radius: 5px; transition: border-color 0.3s; }
        #command-input:focus { border-color: #ffb000; box-shadow: 0 0 10px #ffb000; }
        #execute-btn { background-color: #ffb000; color: #0d0d0d; border: none; padding: 10px 20px; font-family: 'Fira Code', monospace; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 5px; transition: all 0.2s ease; }
        #execute-btn:hover { background-color: #ff4500; transform: translateY(-2px); box-shadow: 0 4px 8px #ff4500; }
        #execute-btn:active { transform: translateY(0); }
        #execute-btn.loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(13, 13, 13, 0.9); }
        .modal-content { background-color: #1a1a1a; margin: 4% auto; padding: 0; border: 2px solid #ffb000; width: 92%; max-width: 900px; height: 80%; display: flex; flex-direction: column; animation: modal-appear 0.3s ease-out; }
        @keyframes modal-appear { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-header { padding: 12px 20px; background-color: #222; border-bottom: 2px solid #ffb000; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { color: #ffb000; font-family: 'Fira Code', monospace; font-size: 18px; }
        .modal-close { color: #e0e0e0; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px; }
        .modal-close:hover { color: #ff4500; }
        .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .modal-body pre { margin: 0; font-family: 'Fira Code', monospace; color: #e0e0e0; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <div class="header-frame">
        <div class="terminal-id">gusofc_terminal_v2</div>
        <div class="control-panel">
            <button id="new-chat-btn" class="control-button">New Chat</button>
        </div>
    </div>

    <div class="terminal-screen" id="chatLog">
    </div>

    <div class="input-section">
        <input type="text" id="command-input" placeholder=">" autocomplete="off">
        <button id="execute-btn">EXEC</button>
    </div>

    <div id="view-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal-title" class="modal-title">output.txt</span>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <pre id="modal-code"></pre>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatLog = document.getElementById('chatLog');
            const commandInput = document.getElementById('command-input');
            const executeBtn = document.getElementById('execute-btn');
            const newChatBtn = document.getElementById('new-chat-btn');
            const viewModal = document.getElementById('view-modal');
            const modalClose = document.querySelector('.modal-close');
            const modalTitle = document.getElementById('modal-title');
            const modalCode = document.getElementById('modal-code');

            const STORAGE_KEY = 'gusofc_terminal_chat';
            let chatHistory = [];

            modalClose.onclick = () => viewModal.style.display = 'none';
            window.onclick = (event) => { if (event.target == viewModal) viewModal.style.display = 'none'; };

            const saveChat = () => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
            };

            const loadChat = () => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    chatHistory = JSON.parse(saved);
                    chatHistory.forEach(entry => {
                        addLogEntry(entry.sender, entry.content, false);
                    });
                } else {
                    addLogEntry('ai', { type: 'text', data: 'Terminal v2 online. Memori aktif. Ketik "code:" untuk membuat file.' });
                }
            };

            const clearChat = () => {
                chatHistory = [];
                saveChat();
                chatLog.innerHTML = '';
                addLogEntry('ai', { type: 'text', data: 'Terminal direset. Memori dibersihkan.' });
            };

            const addLogEntry = (sender, content, shouldSave = true) => {
                if (shouldSave) {
                    chatHistory.push({ sender, content });
                    saveChat();
                }

                const entry = document.createElement('div');
                entry.className = 'log-entry';

                const icon = document.createElement('div');
                icon.className = sender === 'user' ? 'user-icon' : 'ai-icon';
                icon.textContent = sender === 'user' ? 'U' : 'AI';

                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';

                if (sender === 'ai' && content.type === 'code') {
                    bubble.innerHTML = `<p>File dibuat:</p>`;
                    const codeBox = document.createElement('div');
                    codeBox.className = 'code-snippet';
                    const pre = document.createElement('pre');
                    pre.textContent = content.data;
                    codeBox.appendChild(pre);
                    
                    const actions = document.createElement('div');
                    actions.className = 'code-actions';
                    
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'code-action-btn';
                    viewBtn.textContent = 'View';
                    viewBtn.onclick = () => {
                        modalTitle.textContent = getFileName(content.data);
                        modalCode.textContent = content.data;
                        viewModal.style.display = 'block';
                    };

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'code-action-btn';
                    copyBtn.textContent = 'Copy';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(content.data);
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy', 2000);
                    };
                    
                    actions.appendChild(viewBtn);
                    actions.appendChild(copyBtn);
                    codeBox.appendChild(actions);
                    bubble.appendChild(codeBox);
                } else {
                    const p = document.createElement('p');
                    if (sender === 'ai') {
                        typeText(p, content.data || content);
                    } else {
                        p.textContent = content.data || content;
                    }
                    bubble.appendChild(p);
                }

                entry.appendChild(icon);
                entry.appendChild(bubble);
                chatLog.appendChild(entry);
                chatLog.scrollTop = chatLog.scrollHeight;
            };

            const getFileName = (code) => {
                if (code.includes('<!DOCTYPE') || code.includes('<html')) return 'index.html';
                if (code.includes('def ') || code.includes('import ')) return 'main.py';
                if (code.includes('public class ')) return 'Main.java';
                if (code.includes('function ') || code.includes('const ') || code.includes('console.log')) return 'app.js';
                if (code.includes('<?php')) return 'index.php';
                return 'code.txt';
            };

            const typeText = (element, text, speed = 15) => {
                let i = 0;
                element.innerHTML = '';
                const type = () => {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, speed);
                    }
                };
                type();
            };
            
            const showTyping = () => {
                const indicator = document.createElement('div');
                indicator.className = 'typing-indicator';
                indicator.id = 'typing';
                indicator.innerHTML = '<div class="ai-icon"></div><span></span><span></span><span></span>';
                chatLog.appendChild(indicator);
                chatLog.scrollTop = chatLog.scrollHeight;
            };

            const hideTyping = () => {
                const indicator = document.getElementById('typing');
                if (indicator) indicator.remove();
            };

            const runCommand = async (cmdText) => {
                const command = cmdText || commandInput.value.trim();
                if (!command) return;

                addLogEntry('user', { data: command });
                commandInput.value = '';
                executeBtn.disabled = true;
                executeBtn.classList.add('loading');
                executeBtn.textContent = '';
                showTyping();

                try {
                    const response = await fetch('/api/ai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: command }),
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error);
                    addLogEntry('ai', result);
                } catch (error) {
                    addLogEntry('ai', { data: `Error: ${error.message}` });
                } finally {
                    hideTyping();
                    executeBtn.disabled = false;
                    executeBtn.classList.remove('loading');
                    executeBtn.textContent = 'EXEC';
                }
            };

            executeBtn.addEventListener('click', () => runCommand());
            commandInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') runCommand(); });
            newChatBtn.addEventListener('click', clearChat);

            loadChat();
        });
    </script>
</body>
</html>
