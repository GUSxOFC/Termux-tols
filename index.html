<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XavAi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff;
            color: #1a1a1a;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.05);
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #f8f9fa;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-chat-btn:hover {
            background: #333;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .chat-history-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            color: #666;
            position: relative;
        }

        .chat-history-item:hover {
            background: #e5e7eb;
        }

        .chat-history-item.active {
            background: #e5e7eb;
            color: #1a1a1a;
            font-weight: 500;
        }

        .delete-chat {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            color: #999;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .chat-history-item:hover .delete-chat {
            opacity: 1;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-title i {
            color: #6366f1;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid #e5e7eb;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: #f3f4f6;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 90%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .user-avatar {
            background: #6366f1;
            color: white;
        }

        .bot-avatar {
            background: #f3f4f6;
            color: #6366f1;
        }

        .message-content {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #6366f1;
            color: white;
        }

        .message-image {
            max-width: 300px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            overflow-x: auto;
            position: relative;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }

        .code-filename {
            color: #9ca3af;
            font-size: 12px;
        }

        .code-actions {
            display: flex;
            gap: 8px;
        }

        .code-btn {
            background: #333;
            color: #9ca3af;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .code-btn:hover {
            background: #444;
            color: white;
        }

        /* Input Area */
        .input-container {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            background: white;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-box {
            flex: 1;
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: border-color 0.2s;
        }

        .input-box:focus-within {
            border-color: #6366f1;
        }

        #message-input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font-size: 14px;
            resize: none;
            max-height: 120px;
            font-family: inherit;
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .input-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .input-action-btn:hover {
            background: #e5e7eb;
            color: #1a1a1a;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #6366f1;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #5558e3;
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: #e5e7eb;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        /* Image Preview */
        .image-preview {
            display: none;
            margin-bottom: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            align-items: center;
            gap: 12px;
        }

        .image-preview.active {
            display: flex;
        }

        .preview-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .preview-info {
            flex: 1;
            font-size: 13px;
            color: #666;
        }

        .preview-remove {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: #ef4444;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-body img {
            max-width: 100%;
            height: auto;
        }

        /* Image Generation Modal */
        .image-gen-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-width: 400px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
        }

        .form-input, .form-select, .form-textarea {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-select {
            cursor: pointer;
        }

        .generate-btn {
            padding: 12px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .generate-btn:hover {
            background: #5558e3;
        }

        .generate-btn:disabled {
            background: #e5e7eb;
            color: #999;
            cursor: not-allowed;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #1a1a1a;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 2000;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Mobile Responsive */
        .mobile-menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 999;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .message {
                max-width: 95%;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #d1d5db;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="new-chat-btn">
                    <i class="fas fa-plus"></i>
                    Chat Baru
                </button>
            </div>
            <div class="chat-history" id="chat-history"></div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="chat-header">
                <div class="chat-title">
                    <button class="mobile-menu-btn" id="mobile-menu-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <i class="fas fa-robot"></i>
                    XavAi
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="clear-chat-btn" title="Clear Chat">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </header>

            <div class="messages-container" id="messages-container">
                <div class="message bot">
                    <div class="message-avatar bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        Halo! Saya XavAi, asisten AI yang siap membantu Anda. Saya bisa menjawab pertanyaan, membuat kode, dan menghasilkan gambar. Ada yang bisa saya bantu?
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="image-preview" id="image-preview">
                    <img class="preview-img" id="preview-img" src="" alt="Preview">
                    <div class="preview-info">
                        <div id="preview-name"></div>
                        <div id="preview-size"></div>
                    </div>
                    <button class="preview-remove" id="preview-remove">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="input-wrapper">
                    <div class="input-box">
                        <input type="file" id="image-input" accept="image/*" style="display: none;">
                        <button class="input-action-btn" id="attach-btn" title="Attach Image">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="input-action-btn" id="generate-btn" title="Generate Image">
                            <i class="fas fa-magic"></i>
                        </button>
                        <textarea id="message-input" placeholder="Ketik pesan..." rows="1"></textarea>
                    </div>
                    <button class="send-btn" id="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="image-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Gambar</h3>
                <button class="modal-close" data-modal="image-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <img id="modal-image" src="" alt="Full size image">
            </div>
        </div>
    </div>

    <!-- Code Modal -->
    <div class="modal" id="code-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="code-title">Kode</h3>
                <button class="modal-close" data-modal="code-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="code-block">
                    <div class="code-header">
                        <span class="code-filename" id="code-filename">code.txt</span>
                        <div class="code-actions">
                            <button class="code-btn" id="copy-code-btn">
                                <i class="fas fa-copy"></i> Salin
                            </button>
                        </div>
                    </div>
                    <pre id="code-content"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Generation Modal -->
    <div class="modal" id="generate-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Buat Gambar</h3>
                <button class="modal-close" data-modal="generate-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form class="image-gen-form" id="image-gen-form">
                    <div class="form-group">
                        <label class="form-label">Deskripsi Gambar</label>
                        <textarea class="form-textarea" id="image-prompt" placeholder="Jelaskan gambar yang ingin Anda buat..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gaya</label>
                        <select class="form-select" id="image-style">
                            <option value="realistic">Realistis</option>
                            <option value="cartoon">Kartun</option>
                            <option value="anime">Anime</option>
                            <option value="painting">Lukisan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ukuran</label>
                        <select class="form-select" id="image-size">
                            <option value="512x512">512x512</option>
                            <option value="768x768">768x768</option>
                            <option value="1024x1024">1024x1024</option>
                        </select>
                    </div>
                    <button type="submit" class="generate-btn" id="do-generate-btn">
                        <i class="fas fa-magic"></i> Buat Gambar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // State Management
        const state = {
            chats: {},
            currentChatId: null,
            currentImage: null,
            isLoading: false
        };

        // DOM Elements
        const elements = {
            sidebar: document.getElementById('sidebar'),
            chatHistory: document.getElementById('chat-history'),
            messagesContainer: document.getElementById('messages-container'),
            messageInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            newChatBtn: document.getElementById('new-chat-btn'),
            clearChatBtn: document.getElementById('clear-chat-btn'),
            mobileMenuBtn: document.getElementById('mobile-menu-btn'),
            attachBtn: document.getElementById('attach-btn'),
            generateBtn: document.getElementById('generate-btn'),
            imageInput: document.getElementById('image-input'),
            imagePreview: document.getElementById('image-preview'),
            previewImg: document.getElementById('preview-img'),
            previewName: document.getElementById('preview-name'),
            previewSize: document.getElementById('preview-size'),
            previewRemove: document.getElementById('preview-remove'),
            toast: document.getElementById('toast')
        };

        // Storage
        const STORAGE_KEY = 'xavai_chats';
        const CURRENT_CHAT_KEY = 'xavai_current_chat';

        // Initialize
        function init() {
            loadChats();
            setupEventListeners();
            adjustTextareaHeight();
        }

        // Load chats from storage
        function loadChats() {
            const savedChats = localStorage.getItem(STORAGE_KEY);
            if (savedChats) {
                state.chats = JSON.parse(savedChats);
            }
            
            const savedCurrentChat = localStorage.getItem(CURRENT_CHAT_KEY);
            if (savedCurrentChat && state.chats[savedCurrentChat]) {
                state.currentChatId = savedCurrentChat;
            } else {
                createNewChat();
            }
            
            renderChatHistory();
            renderMessages();
        }

        // Save chats to storage
        function saveChats() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.chats));
            localStorage.setItem(CURRENT_CHAT_KEY, state.currentChatId);
        }

        // Create new chat
        function createNewChat() {
            const chatId = generateId();
            state.chats[chatId] = [];
            state.currentChatId = chatId;
            saveChats();
            renderChatHistory();
            renderMessages();
            showToast('Chat baru dibuat');
        }

        // Switch to chat
        function switchToChat(chatId) {
            state.currentChatId = chatId;
            saveChats();
            renderChatHistory();
            renderMessages();
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                elements.sidebar.classList.remove('active');
            }
        }

        // Delete chat
        function deleteChat(chatId, event) {
            event.stopPropagation();
            
            if (confirm('Hapus chat ini?')) {
                delete state.chats[chatId];
                
                if (chatId === state.currentChatId) {
                    const chatIds = Object.keys(state.chats);
                    if (chatIds.length > 0) {
                        state.currentChatId = chatIds[0];
                    } else {
                        createNewChat();
                    }
                }
                
                saveChats();
                renderChatHistory();
                renderMessages();
                showToast('Chat dihapus');
            }
        }

        // Clear current chat
        function clearCurrentChat() {
            if (confirm('Hapus semua pesan di chat ini?')) {
                state.chats[state.currentChatId] = [];
                saveChats();
                renderMessages();
                showToast('Chat dibersihkan');
            }
        }

        // Render chat history
        function renderChatHistory() {
            elements.chatHistory.innerHTML = '';
            
            Object.entries(state.chats).forEach(([chatId, messages]) => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-history-item';
                if (chatId === state.currentChatId) {
                    chatItem.classList.add('active');
                }
                
                const firstMessage = messages.find(m => m.type === 'user');
                const title = firstMessage ? 
                    firstMessage.content.substring(0, 30) + '...' : 
                    'Chat Baru';
                
                chatItem.innerHTML = `
                    ${title}
                    <button class="delete-chat" data-chat-id="${chatId}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                chatItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-chat')) {
                        switchToChat(chatId);
                    }
                });
                
                chatItem.querySelector('.delete-chat').addEventListener('click', (e) => {
                    deleteChat(chatId, e);
                });
                
                elements.chatHistory.appendChild(chatItem);
            });
        }

        // Render messages
        function renderMessages() {
            const messages = state.chats[state.currentChatId] || [];
            
            if (messages.length === 0) {
                elements.messagesContainer.innerHTML = `
                    <div class="message bot">
                        <div class="message-avatar bot-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            Halo! Saya XavAi, asisten AI yang siap membantu Anda. Saya bisa menjawab pertanyaan, membuat kode, dan menghasilkan gambar. Ada yang bisa saya bantu?
                        </div>
                    </div>
                `;
                return;
            }
            
            elements.messagesContainer.innerHTML = '';
            messages.forEach(message => {
                addMessageToDOM(message);
            });
            
            scrollToBottom();
        }

        // Add message to DOM
        function addMessageToDOM(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.type}`;
            
            const avatar = document.createElement('div');
            avatar.className = `message-avatar ${message.type}-avatar`;
            avatar.innerHTML = message.type === 'user' ? 
                '<i class="fas fa-user"></i>' : 
                '<i class="fas fa-robot"></i>';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            if (message.image) {
                const img = document.createElement('img');
                img.className = 'message-image';
                img.src = message.image;
                img.alt = 'Image';
                img.addEventListener('click', () => showImageModal(message.image));
                content.appendChild(img);
            }
            
            if (message.content) {
                const textDiv = document.createElement('div');
                textDiv.textContent = message.content;
                content.appendChild(textDiv);
            }
            
            if (message.code) {
                const codeBlock = createCodeBlock(message.code, message.filename);
                content.appendChild(codeBlock);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            elements.messagesContainer.appendChild(messageDiv);
        }

        // Create code block
        function createCodeBlock(code, filename) {
            const codeBlock = document.createElement('div');
            codeBlock.className = 'code-block';
            
            const header = document.createElement('div');
            header.className = 'code-header';
            header.innerHTML = `
                <span class="code-filename">${filename || 'code.txt'}</span>
                <div class="code-actions">
                    <button class="code-btn">
                        <i class="fas fa-copy"></i> Salin
                    </button>
                </div>
            `;
            
            const pre = document.createElement('pre');
            pre.textContent = code;
            
            header.querySelector('.code-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(code);
                showToast('Kode disalin');
            });
            
            codeBlock.appendChild(header);
            codeBlock.appendChild(pre);
            
            return codeBlock;
        }

        // Send message
        async function sendMessage() {
            const content = elements.messageInput.value.trim();
            const image = state.currentImage;
            
            if (!content && !image) return;
            
            // Add user message
            const userMessage = {
                type: 'user',
                content: content,
                image: image,
                timestamp: new Date().toISOString()
            };
            
            state.chats[state.currentChatId].push(userMessage);
            addMessageToDOM(userMessage);
            
            // Clear input
            elements.messageInput.value = '';
            clearImagePreview();
            adjustTextareaHeight();
            
            // Show loading
            setLoading(true);
            scrollToBottom();
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check for image generation command
                if (content.toLowerCase().startsWith('gambar:')) {
                    const prompt = content.substring(7).trim();
                    const imageUrl = `https://picsum.photos/seed/${encodeURIComponent(prompt)}/512/512.jpg`;
                    
                    const botMessage = {
                        type: 'bot',
                        content: `Gambar yang dibuat: "${prompt}"`,
                        image: imageUrl,
                        timestamp: new Date().toISOString()
                    };
                    
                    state.chats[state.currentChatId].push(botMessage);
                    addMessageToDOM(botMessage);
                } else if (content.toLowerCase().startsWith('code:')) {
                    const code = `// Contoh kode berdasarkan: ${content}\nfunction example() {\n    console.log("Hello, World!");\n    return true;\n}`;
                    
                    const botMessage = {
                        type: 'bot',
                        content: 'Berikut adalah kode yang diminta:',
                        code: code,
                        filename: 'example.js',
                        timestamp: new Date().toISOString()
                    };
                    
                    state.chats[state.currentChatId].push(botMessage);
                    addMessageToDOM(botMessage);
                } else {
                    // Regular response
                    const responses = [
                        'Saya mengerti pertanyaan Anda. Berdasarkan informasi yang ada, saya akan membantu Anda menemukan jawaban terbaik.',
                        'Itu pertanyaan yang menarik! Mari kita bahas lebih lanjut tentang topik tersebut.',
                        'Saya akan membantu Anda dengan ini. Berikut adalah penjelasan yang mungkin berguna bagi Anda.',
                        'Terima kasih atas pertanyaan Anda. Saya akan memberikan informasi yang relevan untuk Anda.'
                    ];
                    
                    const botMessage = {
                        type: 'bot',
                        content: responses[Math.floor(Math.random() * responses.length)],
                        timestamp: new Date().toISOString()
                    };
                    
                    state.chats[state.currentChatId].push(botMessage);
                    addMessageToDOM(botMessage);
                }
                
                saveChats();
                scrollToBottom();
            } catch (error) {
                showToast('Terjadi kesalahan. Silakan coba lagi.');
            } finally {
                setLoading(false);
            }
        }

        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('Ukuran gambar terlalu besar (maks 5MB)');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                state.currentImage = e.target.result;
                showImagePreview(file.name, file.size);
            };
            reader.readAsDataURL(file);
        }

        // Show image preview
        function showImagePreview(name, size) {
            elements.previewImg.src = state.currentImage;
            elements.previewName.textContent = name;
            elements.previewSize.textContent = `${(size / 1024).toFixed(1)} KB`;
            elements.imagePreview.classList.add('active');
        }

        // Clear image preview
        function clearImagePreview() {
            state.currentImage = null;
            elements.imageInput.value = '';
            elements.imagePreview.classList.remove('active');
        }

        // Generate image
        async function generateImage(prompt, style, size) {
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const imageUrl = `https://picsum.photos/seed/${encodeURIComponent(prompt)}/512/512.jpg`;
                
                const botMessage = {
                    type: 'bot',
                    content: `Gambar yang dibuat dengan gaya ${style}: "${prompt}"`,
                    image: imageUrl,
                    timestamp: new Date().toISOString()
                };
                
                state.chats[state.currentChatId].push(botMessage);
                addMessageToDOM(botMessage);
                saveChats();
                scrollToBottom();
                
                closeModal('generate-modal');
                showToast('Gambar berhasil dibuat');
            } catch (error) {
                showToast('Gagal membuat gambar');
            }
        }

        // Set loading state
        function setLoading(isLoading) {
            state.isLoading = isLoading;
            elements.sendBtn.disabled = isLoading;
            if (isLoading) {
                elements.sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            } else {
                elements.sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Show image modal
        function showImageModal(imageSrc) {
            document.getElementById('modal-image').src = imageSrc;
            showModal('image-modal');
        }

        // Show toast notification
        function showToast(message) {
            elements.toast.textContent = message;
            elements.toast.classList.add('show');
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }

        // Scroll to bottom
        function scrollToBottom() {
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // Adjust textarea height
        function adjustTextareaHeight() {
            elements.messageInput.style.height = 'auto';
            elements.messageInput.style.height = Math.min(elements.messageInput.scrollHeight, 120) + 'px';
        }

        // Generate ID
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Send message
            elements.sendBtn.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-resize textarea
            elements.messageInput.addEventListener('input', adjustTextareaHeight);
            
            // New chat
            elements.newChatBtn.addEventListener('click', createNewChat);
            
            // Clear chat
            elements.clearChatBtn.addEventListener('click', clearCurrentChat);
            
            // Mobile menu
            elements.mobileMenuBtn.addEventListener('click', () => {
                elements.sidebar.classList.toggle('active');
            });
            
            // Image upload
            elements.attachBtn.addEventListener('click', () => {
                elements.imageInput.click();
            });
            elements.imageInput.addEventListener('change', handleImageUpload);
            
            // Remove image preview
            elements.previewRemove.addEventListener('click', clearImagePreview);
            
            // Generate image
            elements.generateBtn.addEventListener('click', () => {
                showModal('generate-modal');
            });
            
            // Image generation form
            document.getElementById('image-gen-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const prompt = document.getElementById('image-prompt').value.trim();
                const style = document.getElementById('image-style').value;
                const size = document.getElementById('image-size').value;
                
                if (prompt) {
                    generateImage(prompt, style, size);
                    document.getElementById('image-prompt').value = '';
                }
            });
            
            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    closeModal(btn.dataset.modal);
                });
            });
            
            // Close modal on background click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }

        // Initialize app
        init();
    </script>
</body>
</html>
